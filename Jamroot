# Copyright 2004-2008 Spencer Olson

# alias install : install-headers install-lib ;

# install install-lib : chimplib ;
# 
# install install-headers
#     : [ glob-tree *.h : .svn ]
#     ;
#
# figure out the way to install this:
# pkgconfig_DATA = olson-tools.pc

# 

path-constant OLSON_TOOLS_TOP : . ;

constant VERSION : [ MATCH "\\$Revision: *([0-9]*) *\\$" : "$Revision: 636 $" ] ;

import mpi ;
import os ;
import testing ; # for unit tests

local gcc_fflags = <fflags>-ffree-form ;
local icc_fflags = <fflags>-free ;

local xml2-features = [ mpi.cmdline_to_features [ SHELL "printf '%s ' compiler `xml2-config --cflags --libs`" ] ] ;
rule supports_fast_pow ( )
{
    # this will not work for the pgi compiler
    if [ MATCH "([xX]86).*" : [ os.platform ] ]
    {
        return <define>USE_SPENCERS_FAST_POW ;
    }
}

use-project /physical : ../physical ;
use-project /boost : ../boost ;


project /olson-tools
    : requirements
        $(xml2-features)
        <threading>multi:<define>USE_PTHREAD
        [ supports_fast_pow ]
        <library>/physical//physical
    : usage-requirements
        $(xml2-features)
        <threading>multi:<define>USE_PTHREAD
        [ supports_fast_pow ]
        <library>/physical//physical
    ;

alias headers : : : : <include>src ;

alias xml : : : : <library>/olson-tools//headers <library>/physical//runtime ;

lib random
    : src/olson-tools/random/random.cpp
    : <link>static
      <library>/olson-tools//headers
    ;

lib fit
    : src/olson-tools/fit/debug.cpp
      src/olson-tools/fit/Gene.cpp
      src/olson-tools/fit/io.cpp
    : <link>static
      <library>/olson-tools//headers
      <library>/olson-tools//random
    ;

lib pow
    : src/olson-tools/power.c
    : <link>static
      <library>/olson-tools//headers
    ;

lib misc
    : src/olson-tools/options.cpp
      src/olson-tools/logger.c
      src/olson-tools/3j.c
      src/olson-tools/util.cpp
      src/olson-tools/m_eps.cpp
    : <link>static
      <library>/olson-tools//headers
    ;


# need special compilation for libtrapfe.a
obj trapfe
    : src/olson-tools/trapfe.cpp
    : <optimization>off <variant>debug
      <library>/olson-tools//headers
#   : <os>sunos:<define>__EXTENSIONS__<include>/opt/SUNWspro/WS6U2/include/cc
    ;

obj rk
    : src/olson-tools/rk.F
    :
      <library>/olson-tools//headers
      <toolset>gcc:$(gcc_fflags)
      <toolset>intel:$(icc_fflags)
      <link>static
    ;


install stage : random fit pow misc trapfe rk ;

